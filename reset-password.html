<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Vine Tech | Redefinir Senha</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <header class="app-header">
    <h1 class="logo">Vine Tech</h1>
  </header>

  <main class="app-main auth-main">
    <section class="auth-card">
      <h2>Redefinir senha</h2>
      <p>
        Defina uma nova senha para continuar usando o Vine Tech.
      </p>

      <form id="resetPasswordForm" class="auth-form">
        <div class="form-group">
          <label for="newPassword">Nova senha</label>
          <input
            type="password"
            id="newPassword"
            required
            minlength="6"
            placeholder="Digite a nova senha"
          />
        </div>

        <div class="form-group">
          <label for="confirmPassword">Confirmar nova senha</label>
          <input
            type="password"
            id="confirmPassword"
            required
            minlength="6"
            placeholder="Repita a nova senha"
          />
        </div>

        <div id="resetError" class="error-message" style="display:none;"></div>
        <div id="resetSuccess" class="success-message" style="display:none;"></div>

        <button type="button" id="resetPasswordButton" class="btn btn-primary">
          Salvar nova senha
        </button>
      </form>
    </section>
  </main>

  <footer class="app-footer">
    © Vine Tech — Gestão Inteligente para Gestores de Tráfego
  </footer>

  <!-- Supabase JS (deve ser o mesmo script que você já usa nas outras páginas) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Main JS do Vine Tech -->
  <script src="js/main.js"></script>

  <script>
    // Script específico da página de redefinição
    document.addEventListener("DOMContentLoaded", async () => {
      const form = document.getElementById("resetPasswordForm");
      const btn = document.getElementById("resetPasswordButton");
      const newPasswordInput = document.getElementById("newPassword");
      const confirmPasswordInput = document.getElementById("confirmPassword");
      const errorBox = document.getElementById("resetError");
      const successBox = document.getElementById("resetSuccess");

      function showError(message) {
        errorBox.textContent = message;
        errorBox.style.display = "block";
        successBox.style.display = "none";
      }

      function showSuccess(message) {
        successBox.textContent = message;
        successBox.style.display = "block";
        errorBox.style.display = "none";
      }

      btn.addEventListener("click", async (event) => {
        event.preventDefault();

        const newPassword = newPasswordInput.value.trim();
        const confirmPassword = confirmPasswordInput.value.trim();

        if (!newPassword || !confirmPassword) {
          showError("Preencha os dois campos de senha.");
          return;
        }

        if (newPassword !== confirmPassword) {
          showError("As senhas não conferem. Verifique e tente novamente.");
          return;
        }

        if (newPassword.length < 6) {
          showError("A nova senha deve ter pelo menos 6 caracteres.");
          return;
        }

        btn.disabled = true;
        btn.textContent = "Salvando...";

        try {
          // Supabase já identifica o usuário pela sessão do link do e-mail
          const { data, error } = await supabase.auth.updateUser({
            password: newPassword,
          });

          if (error) {
            console.error("Erro ao atualizar senha:", error.message);
            showError("Não foi possível atualizar a senha. Tente novamente.");
            return;
          }

          showSuccess("Senha redefinida com sucesso! Você já pode fazer login novamente.");

          // Opcional: redirecionar para o login após alguns segundos
          setTimeout(() => {
            window.location.href = "login.html";
          }, 3000);
        } catch (err) {
          console.error("Erro inesperado:", err);
          showError("Erro inesperado ao atualizar a senha.");
        } finally {
          btn.disabled = false;
          btn.textContent = "Salvar nova senha";
        }
      });
    });
  </script>
</body>
</html>
